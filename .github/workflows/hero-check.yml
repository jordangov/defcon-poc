name: Hero Check

on:
  pull_request:
    branches: [ "main" ]

jobs:
  check for hero:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: jordangov/defcon-poc
          # token needss to be able read repo contents, write to PRs, and read secrets
          token: ${{secrets.GH_TOKEN}}
          fetch-depth: 0
      - name: Run script
        run: >-
          git fetch origin main;
          SUBMISSION=`git diff origin/main..HEAD open-source-heros.md | awk '/\* @${{github.actor}}/{ print $3 }'`;
          echo -n "${{github.actor}}-${{secrets.SALT}}" | openssl dgst -${{secrets.ALGO}};
          CHECKSUM=`echo -n "${{github.actor}}-${{secrets.SALT}}" | openssl dgst -${{secrets.ALGO}} | awk '/[a-z0-9]+/{ print $2 }'`;
          echo "Confirming submission ($SUBMISSION) equals checksum ($CHECKSUM)...";
          if [[ "$SUBMISSION" = "$CHECKSUM" ]]; then
            echo "You are an open source hero!";
            exit 0;
          else
            echo "Try again!";
            exit 1;
          fi
