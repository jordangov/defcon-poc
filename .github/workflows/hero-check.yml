name: Hero Check

on:
  pull_request_target:
    branches: [ "main" ]
    paths:
      - 'open-source-heroes.md'

jobs:
  check-for-hero:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Target
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.base.repo.full_name }}
          ref: main
          path: target

      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          path: source

      - name: Check Submission
        id: check_sub
        run: >-
          echo "Checking diff from ${{ github.event.pull_request.head.ref }} on ${{ github.event.pull_request.head.repo.full_name }}...";
          SUBMISSION=`(diff target/open-source-heroes.md source/open-source-heroes.md || true) | awk '/\* @${{ github.event.pull_request.user.login }}/{ print $4 }'`;
          CHECK=`echo -n "${{ github.event.pull_request.user.login }}-${{ secrets.SALT }}" | openssl dgst -${{ secrets.ALGO }} | awk '/[a-z0-9]+/{ print $2 }'`;
          echo "Confirming submission ($SUBMISSION) for ${{ github.event.pull_request.user.login }} equals check...";

          if [[ "$SUBMISSION" = "$CHECK" ]]; then
            echo "Submissions match"
            echo "RESULT=pass" >> "$GITHUB_OUTPUT";
            echo "MESSAGE='ðŸ¤© Wow, you are an open source hero! Find a volunteer with the special White House badge to claim your fame!'" >> "$GITHUB_OUTPUT";
          else
            echo "Submissions do not match"
            echo "RESULT=fail" >> "$GITHUB_OUTPUT";
            echo "MESSAGE='ðŸ˜” Sorry, but that is not the right hash. Have you found all of the clues?'" >> "$GITHUB_OUTPUT";
          fi
      
      - name: Post Message
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ${{ steps.check_sub.outputs.MESSAGE }}
            })
      - name: End Job
        env:
          RESULT: ${{ steps.check_sub.outputs.RESULT }}
        run: >-
          echo "RESULT=$RESULT";
          if [[ "$RESULT" = "pass" ]]; then
            exit 0;
          else
            exit 1;
          fi
